---
title: "Publications"
date: "2025-01-20"
output: html_document
---

<style>
  /* Use more specific selectors */
  body.container {
    max-width: 1200px !important;
    margin: 0 auto !important;
    padding: 20px !important;
  }

  /* Override styles applied to div wrapper if any */
  div.main-container {
    max-width: 1200px !important;
    margin: 0 auto !important;
    padding: 20px !important;
  }

  @media (max-width: 500px) {
    body.container, div.main-container {
      max-width: 100% !important;
      padding: 10px !important;
    }
  }
</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


###  Summary statistics 
(dynamically generated via Plotly and R scholar package)


```{r, message=FALSE, warning=FALSE, cache=TRUE}
library(dplyr)
library(DT)
library(RColorBrewer)
library(scales)
library(tidyverse)
library(scholar)


scholar_id <- "g_m1R7IAAAAJ"

scholar_output <- scholar::get_publications(id = scholar_id) %>%
  rowwise() %>%
  mutate(
    author = case_when(
    str_ends(author, "\\.\\.\\.") ~ get_complete_authors(id = scholar_id, pubid = pubid),
    TRUE ~ author
    )
  ) %>%
ungroup()

citation_history <- scholar::get_citation_history(id = scholar_id)

pubs_per_year <- scholar_output %>%
  group_by(year) %>%
  summarise(publications = n(), .groups = 'drop')

scholar_output_prepped <- scholar_output %>%
  ungroup() %>%
  arrange(desc(year), cites) %>%
  mutate(
    n = seq(1:nrow(.)),
    author = gsub("(G Roff)", "<b>\\1</b>", author, ignore.case = TRUE),  # Use HTML for bold formatting
    cites = as.numeric(cites)  # Ensure cites is numeric
  ) %>%
  select(n, author, year, title, journal, number, cites) %>%
  rename(
    "Year" = "year",
    "Authors" = "author",
    "Journal" = "journal",
    "Issue/Number" = "number",
    "Citations" = "cites"
  )


```

```{r, message=FALSE, warning=FALSE, fig.width=13, fig.height=5, cache=FALSE}
library(scholar)
library(dplyr)
library(ggplot2)
library(plotly)
library(RColorBrewer)

###### Plot 1 – Publications per Year
pubs_per_year <- scholar_output %>%
  group_by(year) %>%
  summarise(publications = n(), .groups = 'drop')

# Generate Spectral palette for publications
num_years <- nrow(pubs_per_year)
colors1 <- colorRampPalette(brewer.pal(11, "Spectral"))(num_years)

pubs_plot <- plot_ly(
  pubs_per_year,
  x = ~year,
  y = ~publications,
  type = 'bar',
  marker = list(
    color = colors1,
    line = list(color = 'black', width = 1)  # Add thin black border
  ),
  hoverinfo = 'text',
  text = ~paste0("Year: ", year, "<br>Publications: ", publications),
  textfont = list(size = 6)
) %>%
  layout(
    title = "Publications per Year",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Number of Publications"),
    showlegend = FALSE
  )

####### Plot 2 – Cumulative Citations per Year
cumulative_citations <- citation_history %>%
  arrange(year) %>%
  mutate(cumulative_cites = cumsum(cites))

# Step 5: Plot 3 – Citations by Publication Rank
scholar_output_ranked <- scholar_output %>%
  arrange(desc(cites)) %>%
  mutate(n = row_number())

# Generate Spectral palette for publication rank plot
num_ranked <- nrow(scholar_output_ranked)
colors_ranked <- colorRampPalette(brewer.pal(8, "RdYlBu"))(num_ranked)

rank_plot <- plot_ly(
  scholar_output_ranked,
  x = ~n,
  y = ~cites,
  type = 'bar',
  marker = list(
    color = colors_ranked,
    line = list(color = 'black', width = 1)  # Add thin black border
  ),
  hoverinfo = 'text',                        # Only display hover text
  text = ~paste0("Title: ", title, "<br>Year: ", year, "<br>Citations: ", cites),
  textfont = list(size = 0)                  # No bar labels displayed
) %>%
  layout(
    title = NULL,
    xaxis = list(title = "Publication Rank"),
    yaxis = list(title = "Cumulative Citations"),
    showlegend = FALSE,
    shapes = list(
      list(
        type = 'line',
        x0 = 0,
        x1 = 1,
        xref = 'paper',
        y0 = 10,
        y1 = 10,
        line = list(
          color = 'black',
          width = 2,
          dash = 'dot'
        )
      )
    )
  )

###### Plot 3 Cumulative citations

# Generate Spectral palette for cumulative citations
num_years2 <- nrow(cumulative_citations)
colors2 <- colorRampPalette((brewer.pal(11, "RdBu")))(num_years2)

citations_plot <- plot_ly(
  cumulative_citations,
  x = ~year,
  y = ~cumulative_cites,
  type = 'scatter',
  mode = 'lines+markers',
  line = list(color = 'black', width = 1),  # Narrow black line
   marker = list(
    color = colors2,
    size = 9,       
    line = list(color = 'black', width = 1)  # Add thin black border
  ),
  hoverinfo = 'text',
  text = ~paste0("Year: ", year, "<br>Cumulative Citations: ", cumulative_cites)
) %>%
  layout(
    title = "",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Cumulative Citations"),
    showlegend = FALSE
  )

# Step 6: Display all three plots in a multi-panel layout
subplot(
  pubs_plot, rank_plot, citations_plot,
  nrows = 1,
  titleX = TRUE,
  titleY = TRUE,
  widths = c(0.3, 0.3, 0.3),  # Adjust plot widths if necessary
  margin = 0.04               # Set spacing between each plot
) %>%
layout(
  xaxis = list(title = "Year / Rank", domain = c(0, 0.3)),    # First plot x-axis domain
  xaxis2 = list(title = "Rank", domain = c(0.35, 0.65)),      # Second plot x-axis domain
  xaxis3 = list(title = "Citations", domain = c(0.7, 1)),     # Last plot x-axis domain
  margin = list(l = 50, r = 50, t = 50, b = 50, pad = 5)     # Adjust outer margins and padding
  #uniformtext = list(minsize = 10, mode = 'show')
)

```




###  Publication list 
(dynamically generated via scholar, bibtex, kbl)

<div style="text-align: center;">
  <img src="images/journals.jpg" style="width:750px;">
</div>


```{r, message=FALSE, warning=FALSE, cache=TRUE}

## All publications to bib
# Convert to BibTeX format
scholar_bib <- scholar_output %>%
  mutate(
    bibtex_entry = paste0(
      "@article{", pubid, ",\n",
      "  title = {", title, "},\n",
      "  author = {", author, "},\n",
      "  journal = {", journal, "},\n",
      "  year = {", year, "},\n",
      "  volume = {", sub(" \\(.*", "", number), "},\n", # Extract volume before '('
      "  number = {", sub(".*\\((.*)\\).*", "\\1", number), "},\n", # Extract issue inside '()'
      "  pages = {", cites, "},\n",
      "  cid = {", cid, "},\n",
      "  pubid = {", pubid, "}\n",
      "}"
    )
  ) %>%
  pull(bibtex_entry)

#writeLines(scholar_bib, "scholar_output.bib")

## select publications to bib
search_terms <- c("Global disparity", "sharks on coral reefs", "evolutionary history", "seascapes", "decline of branching", "decoupled in Holocene")

scholar_bib <- scholar_output %>%
  filter(sapply(title, function(x) any(grepl(paste(search_terms, collapse = "|"), x, ignore.case = TRUE)))) |> 
  mutate(
    bibtex_entry = paste0(
      "@article{", pubid, ",\n",
      "  title = {", title, "},\n",
      "  author = {", author, "},\n",
      "  journal = {", journal, "},\n",
      "  year = {", year, "},\n",
      "  volume = {", sub(" \\(.*", "", number), "},\n", # Extract volume before '('
      "  number = {", sub(".*\\((.*)\\).*", "\\1", number), "},\n", # Extract issue inside '()'
      "  pages = {", cites, "},\n",
      "  cid = {", cid, "},\n",
      "  pubid = {", pubid, "}\n",
      "}"
    )
  ) %>%
  pull(bibtex_entry)

writeLines(scholar_bib, "select_scholar_output.bib")

# Function to lighten a vector of colors
lighten_colors <- function(colors, factor = 0.5) {
  if (factor < 0 || factor > 1) stop("Factor must be between 0 and 1")
  col2rgb(colors) %>%
    t() %>%
    apply(1, function(col) {
      rgb(
        red = col[1] + (255 - col[1]) * factor,
        green = col[2] + (255 - col[2]) * factor,
        blue = col[3] + (255 - col[3]) * factor,
        maxColorValue = 255
      )
    })
}


# Generate colors using RColorBrewer with adjusted alpha
num_colors <- nrow(scholar_output_prepped)
color_palette <- colorRampPalette(rev(brewer.pal(9, "RdYlBu")))(num_colors)
color_palette <- lighten_colors(color_palette, factor = 0.4)  # Set alpha to 0.7

# Map colors to the Citations column
scholar_output_prepped <- scholar_output_prepped %>%
  mutate(
    cite_color = color_palette[rank(Citations, ties.method = "first")]
  )

## kbl format
# scholar_output_prepped %>%
#   select(-cite_color) %>%
#   kbl(escape = FALSE) %>%  # Enable rendering of HTML
#   kable_styling(bootstrap_options = "striped", 
#                 font_size = 12, 
#                 fixed_thead = TRUE,
#                 position = "left") %>%
#   column_spec(7, color = "black", 
#               background = scholar_output_prepped$cite_color) %>%  # Use mapped colors
#   column_spec(2, width_max = "30em") %>%
#   column_spec(4, width_max = "60em") %>%
#   column_spec(5, width_max = "40em") 

# scholar_output |> 
#   group_by(year) |> 
#   summarise(TotalCitations = sum(cites)) |> 
#   mutate(TotalCitations = cumsum(TotalCitations)) |> 
# ggplot() + theme_bw() +
#   geom_point(aes(year, TotalCitations, fill=year), shape=21, show.legend=FALSE) + 
#   scale_fill_distiller(palette="Spectral") + ylab("Cumulative Citations")



## DT format
datatable(
  scholar_output_prepped %>% select(-cite_color),  # Exclude the color column from display
  escape = FALSE,  # Allow HTML for bold formatting
  options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE),
    initComplete = JS(
    "function(settings, json) {",
    "$('body').css({'font-family': 'Arial'});",
    "}"
  ),
    autoWidth = FALSE,
    dom = 't<"bottom"ip>',  # Table with search and pagination
    pageLength = 100,  # Number of rows per page
    columnDefs = list(
      list(className = 'dt-center', targets = "_all"),  # Center-align all columns
      list(width = '10%', targets = 0),  # Column 1 (e.g., n)
      list(width = '30%', targets = 1),  # Column 2 (Authors)
      list(width = '10%', targets = 2),  # Column 3 (Year)
      list(width = '30%', targets = 3),  # Column 4 (Title)
      list(width = '10%', targets = 4),  # Column 5 (Journal)
      list(width = '10%', targets = 5),  # Column 6 (Issue/Number)
      list(width = '10%', targets = 6)   # Column 7 (Citations)
    )
  ),
  rownames = FALSE,
  class = "cell-border stripe"
) %>% formatStyle(
  'Citations',  # Column to style
  backgroundColor = styleEqual(scholar_output_prepped$Citations, scholar_output_prepped$cite_color),
  color = "black"
)


# JIF
# via https://www.google.com/url?sa=t&source=web&rct=j&opi=89978449&url=https://www.nie.re.kr/nie/cmmn/file/fileDown.do%3FatchFileId%3Deacd8968895c44c6a961680f3c0539d6%26fileSn%3D5&ved=2ahUKEwjK-uXPyYeLAxUVyDgGHVAsEeMQFnoECBYQAQ&usg=AOvVaw1_Y5_qHGFtehu4K4W6Uvas

# jif <- read.csv("2024_jif.csv")
# 
# #find.IF.JCR("Ecology", 2024, exact.match = TRUE)
# 
# scholar_output_prepped <- scholar_output_prepped %>%
#   mutate(
#     matched_jif_name = sapply(Journal, function(journal) {
#       # Perform partial matching with grep
#       match_idx <- grep(journal, jif$Name, ignore.case = TRUE)
#       if (length(match_idx) > 0) {
#         jif$Name[match_idx[1]]  # Use the first match if multiple matches exist
#       } else {
#         NA  # No match found
#       }
#     })
#   )

```
